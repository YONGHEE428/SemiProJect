package data.dao;
import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.annotation.*;
import java.io.IOException;
import java.util.HashMap;
import net.nurigo.java_sdk.api.Message;
import net.nurigo.java_sdk.exceptions.CoolsmsException;

@WebServlet("/SendSmsServlet")
public class SendSmsServlet extends HttpServlet {
    private static final String API_KEY = "NCSVFFQSPNIAT4TA";
    private static final String API_SECRET = "GOSOLL5JIYTCSPBBXUEW9YX8PFIDQQ8E";
    private static final String FROM_PHONE = "01083375432";

    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String toPhone = request.getParameter("hp");
        
        HttpSession session = request.getSession(); // 湲곗〈 �꽭�뀡 媛��졇�삤嫄곕굹 �깉濡� �깮�꽦

        // 6�옄由� �씤利앸쾲�샇 �깮�꽦
        String verificationCode = String.valueOf((int)(Math.random() * 900000) + 100000);

        // 臾몄옄 諛쒖넚 以�鍮�
        Message coolsms = new Message(API_KEY, API_SECRET);
        HashMap<String, String> params = new HashMap<>();
        params.put("to", toPhone);
        params.put("from", FROM_PHONE);
        params.put("type", "SMS");
        params.put("text", "[SSY.COM] �씤利앸쾲�샇�뒗 " + verificationCode + " �엯�땲�떎.");
        params.put("app_version", "SSY 1.0");

        response.setContentType("application/json;charset=UTF-8");

        try {
            coolsms.send(params);

            // 湲곗〈 �꽭�뀡�뿉 �씤利앸쾲�샇 媛깆떊
            session.setAttribute("verificationCode", verificationCode);
            session.setAttribute("phoneForVerification", toPhone);

            // JSON �삎�떇�쑝濡� �씤利앸쾲�샇 蹂대궡湲� (�뀒�뒪�듃�슜)
            String json = "{\"verificationCode\":\"" + verificationCode + "\"}";
            response.getWriter().write(json);
        } catch (CoolsmsException e) {
            e.printStackTrace();
            String json = "{\"error\":\"臾몄옄 諛쒖넚�뿉 �떎�뙣�뻽�뒿�땲�떎. �떎�떆 �떆�룄�빐二쇱꽭�슂.\"}";
            response.getWriter().write(json);
        }
    }
}
